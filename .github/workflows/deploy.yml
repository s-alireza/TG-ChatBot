name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Bot
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Auto-detect Cloudflare Account & Setup KV
        id: cf-setup
        run: |
          echo "Detecting Cloudflare account..."
          
          # Get Account ID
          ACCOUNT_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts?page=1&per_page=5" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          ACCOUNT_ID=$(echo $ACCOUNT_RESPONSE | jq -r '.result[0].id')
          ACCOUNT_NAME=$(echo $ACCOUNT_RESPONSE | jq -r '.result[0].name')
          
          if [ "$ACCOUNT_ID" == "null" ] || [ -z "$ACCOUNT_ID" ]; then
            echo "âŒ Failed to get Cloudflare account. Check your API token."
            exit 1
          fi
          
          echo "âœ… Account found: $ACCOUNT_NAME ($ACCOUNT_ID)"
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          
          # Check for existing KV namespace or create one
          echo "Checking KV namespaces..."
          KV_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          KV_ID=$(echo $KV_RESPONSE | jq -r '.result[] | select(.title=="TG_BOT_KV") | .id')
          
          if [ -z "$KV_ID" ] || [ "$KV_ID" == "null" ]; then
            echo "Creating new KV namespace..."
            CREATE_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"title":"TG_BOT_KV"}')
            
            KV_ID=$(echo $CREATE_RESPONSE | jq -r '.result.id')
            
            if [ "$KV_ID" == "null" ] || [ -z "$KV_ID" ]; then
              echo "âŒ Failed to create KV namespace"
              exit 1
            fi
            echo "âœ… Created KV namespace: TG_BOT_KV"
          else
            echo "âœ… Using existing KV namespace: TG_BOT_KV"
          fi
          
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT

      - name: Generate wrangler.toml
        run: |
          cat > wrangler.toml << EOF
          name = "tg-chatbot"
          compatibility_date = "2024-01-01"
          account_id = "${{ steps.cf-setup.outputs.account_id }}"
          main = "src/index.ts"

          [[kv_namespaces]]
          binding = "TG_BOT_KV"
          id = "${{ steps.cf-setup.outputs.kv_id }}"

          [vars]
          TELEGRAM_TOKEN = "${{ secrets.TELEGRAM_TOKEN }}"
          GEMINI_API_KEY = "${{ secrets.GEMINI_API_KEY }}"
          GROQ_API_KEY = "${{ secrets.GROQ_API_KEY }}"
          ACCESS_MODE = "${{ secrets.ACCESS_MODE }}"
          ALLOWED_USER_IDS = "${{ secrets.ALLOWED_USER_IDS }}"
          EOF

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}

      - name: Deployment Complete
        run: |
          echo "âœ… Deployment successful!"
          echo ""
          echo "ðŸ”— To complete setup, visit your worker URL + /setup-webhook"
          echo "   Example: https://tg-chatbot.YOUR_SUBDOMAIN.workers.dev/setup-webhook"
